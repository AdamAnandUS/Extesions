<article class="_2rhmJa"><ul>
<li>1 添加依赖</li>
<li>2 在 main 文件夹下创建 .proto 文件</li>
<li>3 编写 Serializer</li>
<li>4 编写基础存储工具类</li>
<li>5 举例使用<br>
**   5.1 创建 DataStore 存储工具子类<br>
**   5.2 基本使用</li>
<li>6 混淆</li>
</ul>
<h2>0 使用 SharedPreferences 保存数据</h2>
<h3>0.1 创建SP Base 类</h3>
<div class="_2Uzcx_"><button class="VJbwyy" type="button" aria-label="复制代码"><i aria-label="icon: copy" class="anticon anticon-copy"><svg viewBox="64 64 896 896" focusable="false" class="" data-icon="copy" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2L263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></i></button><pre class="line-numbers  language-kotlin"><code class="  language-kotlin"><span class="token keyword">open</span> <span class="token keyword">class</span> <span class="token function">BaseSp</span><span class="token punctuation">(</span><span class="token keyword">val</span> name<span class="token operator">:</span> String <span class="token operator">=</span> <span class="token string">"Clear"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>


    <span class="token keyword">private</span> <span class="token keyword">var</span> sp<span class="token operator">:</span> SharedPreferences<span class="token operator">?</span> <span class="token operator">=</span>
        AppApplication<span class="token punctuation">.</span>context<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">getSharedPreferences</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> Context<span class="token punctuation">.</span>MODE_PRIVATE<span class="token punctuation">)</span>

    <span class="token keyword">fun</span> <span class="token function">setValue</span><span class="token punctuation">(</span>key<span class="token operator">:</span> String<span class="token punctuation">,</span> any<span class="token operator">:</span> Any<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        sp<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">let</span> <span class="token punctuation">{</span>
            <span class="token keyword">val</span> edit <span class="token operator">=</span> it<span class="token punctuation">.</span><span class="token function">edit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">when</span> <span class="token punctuation">(</span>any<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">is</span> String <span class="token operator">-&gt;</span> edit<span class="token punctuation">.</span><span class="token function">putString</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> any<span class="token punctuation">)</span>
                <span class="token keyword">is</span> Boolean <span class="token operator">-&gt;</span> edit<span class="token punctuation">.</span><span class="token function">putBoolean</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> any<span class="token punctuation">)</span>
                <span class="token keyword">is</span> Int <span class="token operator">-&gt;</span> edit<span class="token punctuation">.</span><span class="token function">putInt</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> any<span class="token punctuation">)</span>
                <span class="token keyword">is</span> Long <span class="token operator">-&gt;</span> edit<span class="token punctuation">.</span><span class="token function">putLong</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> any<span class="token punctuation">)</span>
                <span class="token keyword">is</span> Float <span class="token operator">-&gt;</span> edit<span class="token punctuation">.</span><span class="token function">putFloat</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> any<span class="token punctuation">)</span>
                <span class="token keyword">else</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                    edit<span class="token punctuation">.</span><span class="token function">putString</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> any<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            edit<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fun</span> <span class="token function">getBooleanValue</span><span class="token punctuation">(</span>key<span class="token operator">:</span> String<span class="token punctuation">,</span> default<span class="token operator">:</span> Boolean<span class="token punctuation">)</span><span class="token operator">:</span> Boolean <span class="token punctuation">{</span>
        <span class="token keyword">return</span> sp<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">getBoolean</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> default<span class="token punctuation">)</span> <span class="token operator">?:</span> default
    <span class="token punctuation">}</span>

    <span class="token keyword">fun</span> <span class="token function">getStringValue</span><span class="token punctuation">(</span>key<span class="token operator">:</span> String<span class="token punctuation">,</span> default<span class="token operator">:</span> String<span class="token operator">?</span> <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token operator">:</span> String<span class="token operator">?</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> sp<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> default<span class="token punctuation">)</span> <span class="token operator">?:</span> default
    <span class="token punctuation">}</span>

    <span class="token keyword">fun</span> <span class="token function">getIntValue</span><span class="token punctuation">(</span>key<span class="token operator">:</span> String<span class="token punctuation">,</span> default<span class="token operator">:</span> Int<span class="token punctuation">)</span><span class="token operator">:</span> Int <span class="token punctuation">{</span>
        <span class="token keyword">return</span> sp<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> default<span class="token punctuation">)</span> <span class="token operator">?:</span> default
    <span class="token punctuation">}</span>

    <span class="token keyword">fun</span> <span class="token function">getLongValue</span><span class="token punctuation">(</span>key<span class="token operator">:</span> String<span class="token punctuation">,</span> default<span class="token operator">:</span> Long<span class="token punctuation">)</span><span class="token operator">:</span> Long <span class="token punctuation">{</span>
        <span class="token keyword">return</span> sp<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">getLong</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> default<span class="token punctuation">)</span> <span class="token operator">?:</span> default
    <span class="token punctuation">}</span>

    <span class="token keyword">fun</span> <span class="token function">getFloatValue</span><span class="token punctuation">(</span>key<span class="token operator">:</span> String<span class="token punctuation">,</span> default<span class="token operator">:</span> Float<span class="token punctuation">)</span><span class="token operator">:</span> Float <span class="token punctuation">{</span>
        <span class="token keyword">return</span> sp<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">getFloat</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> default<span class="token punctuation">)</span> <span class="token operator">?:</span> default
    <span class="token punctuation">}</span>


    <span class="token keyword">fun</span> <span class="token function">clearAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        sp<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">edit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>
<h3>0.2 继承SP Base 实现自己的 sp 文件</h3>
<div class="_2Uzcx_"><button class="VJbwyy" type="button" aria-label="复制代码"><i aria-label="icon: copy" class="anticon anticon-copy"><svg viewBox="64 64 896 896" focusable="false" class="" data-icon="copy" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2L263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></i></button><pre class="line-numbers  language-csharp"><code class="  language-csharp"><span class="token keyword">object</span> MySp <span class="token punctuation">:</span> <span class="token function">BaseSp</span><span class="token punctuation">(</span><span class="token string">"可选sp名"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></div>
<h2>1 添加依赖</h2>
<div class="_2Uzcx_"><button class="VJbwyy" type="button" aria-label="复制代码"><i aria-label="icon: copy" class="anticon anticon-copy"><svg viewBox="64 64 896 896" focusable="false" class="" data-icon="copy" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2L263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></i></button><pre class="line-numbers  language-css"><code class="  language-css">    implementation <span class="token string">"androidx.datastore:datastore:1.0.0-alpha06"</span>
    implementation <span class="token string">"androidx.datastore:datastore-preferences:1.0.0-alpha06"</span>
    implementation <span class="token string">"com.google.protobuf:protobuf-java:3.15.0"</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></div>
<h2>2 在 main 文件夹下创建 <code>.proto</code>文件</h2>
<p><a href="https://links.jianshu.com/go?to=https%3A%2F%2Fdevelopers.google.com%2Fprotocol-buffers%2Fdocs%2Fproto3" target="_blank">Proto 编写指南</a><br>
</p><div class="image-package">
<div class="image-container" style="max-width: 279px; max-height: 221px;">
<div class="image-container-fill" style="padding-bottom: 79.21000000000001%;"></div>
<div class="image-view" data-width="279" data-height="221"><img data-original-src="//upload-images.jianshu.io/upload_images/10733883-7eb1488ae32ff253.png" data-original-width="279" data-original-height="221" data-original-format="image/png" data-original-filesize="14445" data-image-index="0" style="cursor: zoom-in;" class="image-loading"></div>
</div>
<div class="image-caption">.proto</div>
</div><p></p>
<div class="_2Uzcx_"><button class="VJbwyy" type="button" aria-label="复制代码"><i aria-label="icon: copy" class="anticon anticon-copy"><svg viewBox="64 64 896 896" focusable="false" class="" data-icon="copy" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2L263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></i></button><pre class="line-numbers  language-go"><code class="  language-go">syntax <span class="token operator">=</span> <span class="token string">"proto3"</span><span class="token punctuation">;</span>

option java_package <span class="token operator">=</span> <span class="token string">"com.afra55.xxx.ds.event"</span><span class="token punctuation">;</span>
option java_multiple_files <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

message MessageEvent <span class="token punctuation">{</span>
  <span class="token builtin">int32</span> <span class="token keyword">type</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token builtin">string</span> message <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>
<p>根据不同的存储需求来实现不同的 proto 文件，然后进行编译, java_package 是生成文件的路径<br>
<code>protoc -I=$SRC_DIR --java_out=$DST_DIR $SRC_DIR/ds.proto</code></p>
<p>例如当在 proto 文件夹下：</p>
<div class="_2Uzcx_"><button class="VJbwyy" type="button" aria-label="复制代码"><i aria-label="icon: copy" class="anticon anticon-copy"><svg viewBox="64 64 896 896" focusable="false" class="" data-icon="copy" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2L263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></i></button><pre class="line-numbers  language-undefined"><code class="  language-undefined">protoc -I=. --java_out=../java ./ds.proto
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div>
<p>许多标准的简单数据类型都可以作为字段类型，包括bool，int32，float，double，和string。</p>
<div class="image-package">
<div class="image-container" style="max-width: 206px; max-height: 60px;">
<div class="image-container-fill" style="padding-bottom: 29.13%;"></div>
<div class="image-view" data-width="206" data-height="60"><img data-original-src="//upload-images.jianshu.io/upload_images/10733883-7bd9975d6b0463fe.png" data-original-width="206" data-original-height="60" data-original-format="image/png" data-original-filesize="7364" data-image-index="1" style="cursor: zoom-in;" class="image-loading"></div>
</div>
<div class="image-caption">ds</div>
</div>
<p>protoc 命令下载地址：<br>
<a href="https://links.jianshu.com/go?to=https%3A%2F%2Fgithub.com%2Fprotocolbuffers%2Fprotobuf%2Freleases" target="_blank">https://github.com/protocolbuffers/protobuf/releases</a></p>
<h2>3 编写 Serializer</h2>
<div class="_2Uzcx_"><button class="VJbwyy" type="button" aria-label="复制代码"><i aria-label="icon: copy" class="anticon anticon-copy"><svg viewBox="64 64 896 896" focusable="false" class="" data-icon="copy" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2L263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></i></button><pre class="line-numbers  language-kotlin"><code class="  language-kotlin"><span class="token keyword">object</span> MessageEventSerializer <span class="token operator">:</span>Serializer<span class="token operator">&lt;</span>MessageEvent<span class="token operator">&gt;</span><span class="token punctuation">{</span>

    <span class="token keyword">override</span> <span class="token keyword">val</span> defaultValue<span class="token operator">:</span> MessageEvent
        <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> MessageEvent<span class="token punctuation">.</span><span class="token function">getDefaultInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">readFrom</span><span class="token punctuation">(</span>input<span class="token operator">:</span> InputStream<span class="token punctuation">)</span><span class="token operator">:</span> MessageEvent <span class="token punctuation">{</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> MessageEvent<span class="token punctuation">.</span><span class="token function">parseFrom</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> Exception<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token function">CorruptionException</span><span class="token punctuation">(</span><span class="token string">"Cannot read proto."</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">writeTo</span><span class="token punctuation">(</span>t<span class="token operator">:</span> MessageEvent<span class="token punctuation">,</span> output<span class="token operator">:</span> OutputStream<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        t<span class="token punctuation">.</span><span class="token function">writeTo</span><span class="token punctuation">(</span>output<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>
<h2>4 编写基础存储工具类</h2>
<div class="_2Uzcx_"><button class="VJbwyy" type="button" aria-label="复制代码"><i aria-label="icon: copy" class="anticon anticon-copy"><svg viewBox="64 64 896 896" focusable="false" class="" data-icon="copy" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2L263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></i></button><pre class="line-numbers  language-swift"><code class="  language-swift">
<span class="token keyword">import</span> androidx<span class="token punctuation">.</span>datastore<span class="token punctuation">.</span>core<span class="token punctuation">.</span><span class="token builtin">DataStore</span>
<span class="token keyword">import</span> androidx<span class="token punctuation">.</span>datastore<span class="token punctuation">.</span>createDataStore
<span class="token keyword">import</span> androidx<span class="token punctuation">.</span>datastore<span class="token punctuation">.</span>preferences<span class="token punctuation">.</span>core<span class="token punctuation">.</span><span class="token operator">*</span>
<span class="token keyword">import</span> androidx<span class="token punctuation">.</span>datastore<span class="token punctuation">.</span>preferences<span class="token punctuation">.</span>createDataStore
<span class="token keyword">import</span> androidx<span class="token punctuation">.</span>datastore<span class="token punctuation">.</span>createDataStore
<span class="token keyword">import</span> com<span class="token punctuation">.</span>afra55<span class="token punctuation">.</span>thunderomadtestapplication<span class="token punctuation">.</span><span class="token builtin">AppApplication</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>afra55<span class="token punctuation">.</span>thunderomadtestapplication<span class="token punctuation">.</span>ds<span class="token punctuation">.</span>event<span class="token punctuation">.</span><span class="token builtin">MessageEvent</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>afra55<span class="token punctuation">.</span>thunderomadtestapplication<span class="token punctuation">.</span>toJsonString
<span class="token keyword">import</span> com<span class="token punctuation">.</span>afra55<span class="token punctuation">.</span>thunderomadtestapplication<span class="token punctuation">.</span>toObject
<span class="token keyword">import</span> kotlinx<span class="token punctuation">.</span>coroutines<span class="token punctuation">.</span><span class="token builtin">Dispatchers</span>
<span class="token keyword">import</span> kotlinx<span class="token punctuation">.</span>coroutines<span class="token punctuation">.</span>flow<span class="token punctuation">.</span><span class="token builtin">Flow</span>
<span class="token keyword">import</span> kotlinx<span class="token punctuation">.</span>coroutines<span class="token punctuation">.</span>flow<span class="token punctuation">.</span><span class="token builtin">first</span>
<span class="token keyword">import</span> kotlinx<span class="token punctuation">.</span>coroutines<span class="token punctuation">.</span>flow<span class="token punctuation">.</span>flowOn
<span class="token keyword">import</span> kotlinx<span class="token punctuation">.</span>coroutines<span class="token punctuation">.</span>flow<span class="token punctuation">.</span><span class="token builtin">map</span>
<span class="token keyword">import</span> kotlin<span class="token punctuation">.</span><span class="token builtin">reflect</span><span class="token punctuation">.</span><span class="token builtin">KClass</span>

<span class="token comment">/**
 * @author Afra55
 * @date 2/18/21
 * A smile is the best business card.
 *
 * 需要添加混淆：
-keepclassmembers class * extends androidx.datastore.preferences.protobuf.GeneratedMessageLite {
&lt;fields&gt;;
}
 */</span>
open <span class="token keyword">class</span> <span class="token class-name">DataStoreBase</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> <span class="token builtin">String</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    val dataStore<span class="token punctuation">:</span> <span class="token builtin">DataStore</span><span class="token operator">&lt;</span><span class="token builtin">Preferences</span><span class="token operator">&gt;</span><span class="token operator">?</span> by <span class="token keyword">lazy</span> <span class="token punctuation">{</span>
        <span class="token builtin">AppApplication</span><span class="token punctuation">.</span>context<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">createDataStore</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    val messageEventDataStore<span class="token punctuation">:</span> <span class="token builtin">DataStore</span><span class="token operator">&lt;</span><span class="token builtin">MessageEvent</span><span class="token operator">&gt;</span><span class="token operator">?</span> by <span class="token keyword">lazy</span> <span class="token punctuation">{</span>
        <span class="token builtin">AppApplication</span><span class="token punctuation">.</span>context<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">createDataStore</span><span class="token punctuation">(</span>
            fileName <span class="token operator">=</span> name<span class="token punctuation">,</span>
            serializer <span class="token operator">=</span> <span class="token builtin">MessageEventSerializer</span>
        <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>


    suspend fun <span class="token function">getString</span><span class="token punctuation">(</span>key<span class="token punctuation">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span> defaultValue<span class="token punctuation">:</span><span class="token builtin">String</span><span class="token operator">?</span> <span class="token operator">=</span> null<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token builtin">String</span><span class="token operator">?</span> <span class="token punctuation">{</span>
       <span class="token keyword">return</span> dataStore<span class="token operator">?</span><span class="token punctuation">.</span>data<span class="token operator">?</span><span class="token punctuation">.</span><span class="token builtin">map</span> <span class="token punctuation">{</span> preferences <span class="token operator">-</span><span class="token operator">&gt;</span>
            preferences<span class="token punctuation">[</span><span class="token function">stringPreferencesKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">?</span><span class="token punctuation">:</span> defaultValue
        <span class="token punctuation">}</span><span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">first</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    suspend fun <span class="token function">getInt</span><span class="token punctuation">(</span>key<span class="token punctuation">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span> defaultValue<span class="token punctuation">:</span><span class="token builtin">Int</span><span class="token operator">?</span> <span class="token operator">=</span> null<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token builtin">Int</span><span class="token operator">?</span> <span class="token punctuation">{</span>
       <span class="token keyword">return</span> dataStore<span class="token operator">?</span><span class="token punctuation">.</span>data<span class="token operator">?</span><span class="token punctuation">.</span><span class="token builtin">map</span> <span class="token punctuation">{</span> preferences <span class="token operator">-</span><span class="token operator">&gt;</span>
            preferences<span class="token punctuation">[</span><span class="token function">intPreferencesKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">?</span><span class="token punctuation">:</span> defaultValue
        <span class="token punctuation">}</span><span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">first</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    suspend fun <span class="token function">getDouble</span><span class="token punctuation">(</span>key<span class="token punctuation">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span> defaultValue<span class="token punctuation">:</span><span class="token builtin">Double</span><span class="token operator">?</span> <span class="token operator">=</span> null<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token builtin">Double</span><span class="token operator">?</span> <span class="token punctuation">{</span>
       <span class="token keyword">return</span> dataStore<span class="token operator">?</span><span class="token punctuation">.</span>data<span class="token operator">?</span><span class="token punctuation">.</span><span class="token builtin">map</span> <span class="token punctuation">{</span> preferences <span class="token operator">-</span><span class="token operator">&gt;</span>
            preferences<span class="token punctuation">[</span><span class="token function">doublePreferencesKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">?</span><span class="token punctuation">:</span> defaultValue
        <span class="token punctuation">}</span><span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">first</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    suspend fun <span class="token function">getBoolean</span><span class="token punctuation">(</span>key<span class="token punctuation">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span> defaultValue<span class="token punctuation">:</span><span class="token builtin">Boolean</span><span class="token operator">?</span> <span class="token operator">=</span> null<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token builtin">Boolean</span><span class="token operator">?</span> <span class="token punctuation">{</span>
       <span class="token keyword">return</span> dataStore<span class="token operator">?</span><span class="token punctuation">.</span>data<span class="token operator">?</span><span class="token punctuation">.</span><span class="token builtin">map</span> <span class="token punctuation">{</span> preferences <span class="token operator">-</span><span class="token operator">&gt;</span>
            preferences<span class="token punctuation">[</span><span class="token function">booleanPreferencesKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">?</span><span class="token punctuation">:</span> defaultValue
        <span class="token punctuation">}</span><span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">first</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    suspend fun <span class="token function">getFloat</span><span class="token punctuation">(</span>key<span class="token punctuation">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span> defaultValue<span class="token punctuation">:</span><span class="token builtin">Float</span><span class="token operator">?</span> <span class="token operator">=</span> null<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token builtin">Float</span><span class="token operator">?</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> dataStore<span class="token operator">?</span><span class="token punctuation">.</span>data<span class="token operator">?</span><span class="token punctuation">.</span><span class="token builtin">map</span> <span class="token punctuation">{</span> preferences <span class="token operator">-</span><span class="token operator">&gt;</span>
            preferences<span class="token punctuation">[</span><span class="token function">floatPreferencesKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">?</span><span class="token punctuation">:</span> defaultValue
        <span class="token punctuation">}</span><span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">first</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    suspend fun <span class="token function">getLong</span><span class="token punctuation">(</span>key<span class="token punctuation">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span> defaultValue<span class="token punctuation">:</span><span class="token builtin">Long</span><span class="token operator">?</span> <span class="token operator">=</span> null<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token builtin">Long</span><span class="token operator">?</span> <span class="token punctuation">{</span>
       <span class="token keyword">return</span> dataStore<span class="token operator">?</span><span class="token punctuation">.</span>data<span class="token operator">?</span><span class="token punctuation">.</span><span class="token builtin">map</span> <span class="token punctuation">{</span> preferences <span class="token operator">-</span><span class="token operator">&gt;</span>
            preferences<span class="token punctuation">[</span><span class="token function">longPreferencesKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">?</span><span class="token punctuation">:</span> defaultValue
        <span class="token punctuation">}</span><span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">first</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    suspend fun <span class="token function">getStringSet</span><span class="token punctuation">(</span>key<span class="token punctuation">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span> defaultValue<span class="token punctuation">:</span><span class="token builtin">Set</span><span class="token operator">&lt;</span><span class="token builtin">String</span><span class="token operator">&gt;</span><span class="token operator">?</span> <span class="token operator">=</span> null<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token builtin">Set</span><span class="token operator">&lt;</span><span class="token builtin">String</span><span class="token operator">&gt;</span><span class="token operator">?</span> <span class="token punctuation">{</span>
       <span class="token keyword">return</span> dataStore<span class="token operator">?</span><span class="token punctuation">.</span>data<span class="token operator">?</span><span class="token punctuation">.</span><span class="token builtin">map</span> <span class="token punctuation">{</span> preferences <span class="token operator">-</span><span class="token operator">&gt;</span>
            preferences<span class="token punctuation">[</span><span class="token function">stringSetPreferencesKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">?</span><span class="token punctuation">:</span> defaultValue
        <span class="token punctuation">}</span><span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">first</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    suspend fun <span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> <span class="token function">getObject</span><span class="token punctuation">(</span>key<span class="token punctuation">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span> clazz<span class="token punctuation">:</span> <span class="token builtin">Class</span><span class="token operator">&lt;</span>T<span class="token operator">&gt;</span><span class="token punctuation">,</span> defaultValue<span class="token punctuation">:</span>T<span class="token operator">?</span> <span class="token operator">=</span> null<span class="token punctuation">)</span><span class="token punctuation">:</span> T<span class="token operator">?</span> <span class="token punctuation">{</span>
       <span class="token keyword">return</span> dataStore<span class="token operator">?</span><span class="token punctuation">.</span>data<span class="token operator">?</span><span class="token punctuation">.</span><span class="token builtin">map</span> <span class="token punctuation">{</span> preferences <span class="token operator">-</span><span class="token operator">&gt;</span>
           val a <span class="token operator">=</span> preferences<span class="token punctuation">[</span><span class="token function">stringPreferencesKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">]</span>
           <span class="token keyword">if</span> <span class="token punctuation">(</span>a <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
               a<span class="token punctuation">.</span><span class="token function">toObject</span><span class="token punctuation">(</span>clazz<span class="token punctuation">)</span> <span class="token keyword">as</span> T
           <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
               defaultValue
           <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">first</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    suspend fun <span class="token operator">&lt;</span>T <span class="token punctuation">:</span> <span class="token builtin">Any</span><span class="token operator">&gt;</span> <span class="token keyword">get</span><span class="token punctuation">(</span>key<span class="token punctuation">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span> clazz<span class="token punctuation">:</span> <span class="token builtin">KClass</span><span class="token operator">&lt;</span>T<span class="token operator">&gt;</span><span class="token punctuation">,</span> defaultValue<span class="token punctuation">:</span> T<span class="token operator">?</span> <span class="token operator">=</span> null<span class="token punctuation">)</span><span class="token punctuation">:</span> T<span class="token operator">?</span> <span class="token punctuation">{</span>

        val pKey <span class="token operator">=</span> when <span class="token punctuation">(</span>clazz<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token builtin">String</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token keyword">class</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
                <span class="token function">stringPreferencesKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token builtin">Int</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token keyword">class</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
                <span class="token function">intPreferencesKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token builtin">Double</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token keyword">class</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
                <span class="token function">doublePreferencesKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token builtin">Boolean</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token keyword">class</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
                <span class="token function">booleanPreferencesKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token builtin">Float</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token keyword">class</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
                <span class="token function">floatPreferencesKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token builtin">Long</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token keyword">class</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
                <span class="token function">longPreferencesKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token builtin">Set</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token keyword">class</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
                <span class="token function">stringSetPreferencesKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
                null
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> dataStore<span class="token operator">?</span><span class="token punctuation">.</span>data<span class="token operator">?</span><span class="token punctuation">.</span><span class="token builtin">map</span> <span class="token punctuation">{</span> preferences <span class="token operator">-</span><span class="token operator">&gt;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>pKey <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token punctuation">(</span>preferences<span class="token punctuation">[</span>pKey<span class="token punctuation">]</span> <span class="token keyword">as</span><span class="token operator">?</span> T<span class="token punctuation">)</span> <span class="token operator">?</span><span class="token punctuation">:</span> defaultValue
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                val a <span class="token operator">=</span> preferences<span class="token punctuation">[</span><span class="token function">stringPreferencesKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">]</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>a <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    a<span class="token punctuation">.</span><span class="token function">toObject</span><span class="token punctuation">(</span>clazz<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token keyword">class</span><span class="token punctuation">.</span>java<span class="token punctuation">)</span> <span class="token keyword">as</span> T
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    defaultValue
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">first</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    suspend fun <span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span> value<span class="token punctuation">:</span> <span class="token builtin">Any</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        when <span class="token punctuation">(</span>value<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token builtin">String</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token keyword">class</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
                dataStore<span class="token operator">?</span><span class="token punctuation">.</span>edit <span class="token punctuation">{</span> settings <span class="token operator">-</span><span class="token operator">&gt;</span>
                    settings<span class="token punctuation">[</span><span class="token function">stringPreferencesKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> value <span class="token keyword">as</span> <span class="token builtin">String</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token builtin">Int</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token keyword">class</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
                dataStore<span class="token operator">?</span><span class="token punctuation">.</span>edit <span class="token punctuation">{</span> settings <span class="token operator">-</span><span class="token operator">&gt;</span>
                    settings<span class="token punctuation">[</span><span class="token function">intPreferencesKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> value <span class="token keyword">as</span> <span class="token builtin">Int</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token builtin">Double</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token keyword">class</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
                dataStore<span class="token operator">?</span><span class="token punctuation">.</span>edit <span class="token punctuation">{</span> settings <span class="token operator">-</span><span class="token operator">&gt;</span>
                    settings<span class="token punctuation">[</span><span class="token function">doublePreferencesKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> value <span class="token keyword">as</span> <span class="token builtin">Double</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token builtin">Boolean</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token keyword">class</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
                dataStore<span class="token operator">?</span><span class="token punctuation">.</span>edit <span class="token punctuation">{</span> settings <span class="token operator">-</span><span class="token operator">&gt;</span>
                    settings<span class="token punctuation">[</span><span class="token function">booleanPreferencesKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> value <span class="token keyword">as</span> <span class="token builtin">Boolean</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token builtin">Float</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token keyword">class</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
                dataStore<span class="token operator">?</span><span class="token punctuation">.</span>edit <span class="token punctuation">{</span> settings <span class="token operator">-</span><span class="token operator">&gt;</span>
                    settings<span class="token punctuation">[</span><span class="token function">floatPreferencesKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> value <span class="token keyword">as</span> <span class="token builtin">Float</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token builtin">Long</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token keyword">class</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
                dataStore<span class="token operator">?</span><span class="token punctuation">.</span>edit <span class="token punctuation">{</span> settings <span class="token operator">-</span><span class="token operator">&gt;</span>
                    settings<span class="token punctuation">[</span><span class="token function">longPreferencesKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> value <span class="token keyword">as</span> <span class="token builtin">Long</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token builtin">Set</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token keyword">class</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
                dataStore<span class="token operator">?</span><span class="token punctuation">.</span>edit <span class="token punctuation">{</span> settings <span class="token operator">-</span><span class="token operator">&gt;</span>
                    settings<span class="token punctuation">[</span><span class="token function">stringSetPreferencesKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> value <span class="token keyword">as</span> <span class="token builtin">Set</span><span class="token operator">&lt;</span><span class="token builtin">String</span><span class="token operator">&gt;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
                dataStore<span class="token operator">?</span><span class="token punctuation">.</span>edit <span class="token punctuation">{</span> settings <span class="token operator">-</span><span class="token operator">&gt;</span>
                    settings<span class="token punctuation">[</span><span class="token function">stringPreferencesKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">.</span><span class="token function">toJsonString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>


    suspend fun <span class="token function">getMessageEventType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token builtin">Int</span><span class="token operator">?</span>  <span class="token punctuation">{</span>
        <span class="token keyword">return</span> messageEventDataStore<span class="token operator">?</span><span class="token punctuation">.</span>data<span class="token operator">?</span><span class="token punctuation">.</span><span class="token builtin">map</span> <span class="token punctuation">{</span>
            it<span class="token punctuation">.</span>type
        <span class="token punctuation">}</span><span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">first</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    suspend fun <span class="token function">getMessageEventData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token builtin">String</span><span class="token operator">?</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> messageEventDataStore<span class="token operator">?</span><span class="token punctuation">.</span>data<span class="token operator">?</span><span class="token punctuation">.</span><span class="token builtin">map</span> <span class="token punctuation">{</span>
            it<span class="token punctuation">.</span>message
        <span class="token punctuation">}</span><span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">first</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    suspend fun <span class="token function">getMessageEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token builtin">MessageEvent</span><span class="token operator">?</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> messageEventDataStore<span class="token operator">?</span><span class="token punctuation">.</span>data<span class="token operator">?</span><span class="token punctuation">.</span><span class="token builtin">map</span> <span class="token punctuation">{</span>
            it
        <span class="token punctuation">}</span><span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">first</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    suspend fun <span class="token function">putMessageEvent</span><span class="token punctuation">(</span>message<span class="token punctuation">:</span><span class="token builtin">String</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        messageEventDataStore<span class="token operator">?</span><span class="token punctuation">.</span>updateData <span class="token punctuation">{</span>
            it<span class="token punctuation">.</span><span class="token function">toBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setType</span><span class="token punctuation">(</span>it<span class="token punctuation">.</span>type<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setMessage</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    suspend fun <span class="token function">putMessageEvent</span><span class="token punctuation">(</span>type<span class="token punctuation">:</span><span class="token builtin">Int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        messageEventDataStore<span class="token operator">?</span><span class="token punctuation">.</span>updateData <span class="token punctuation">{</span>
            it<span class="token punctuation">.</span><span class="token function">toBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setType</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setMessage</span><span class="token punctuation">(</span>it<span class="token punctuation">.</span>message<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    suspend fun <span class="token function">putMessageEvent</span><span class="token punctuation">(</span>type<span class="token punctuation">:</span><span class="token builtin">Int</span><span class="token punctuation">,</span> message<span class="token punctuation">:</span><span class="token builtin">String</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        messageEventDataStore<span class="token operator">?</span><span class="token punctuation">.</span>updateData <span class="token punctuation">{</span>
            it<span class="token punctuation">.</span><span class="token function">toBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setType</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setMessage</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>
<h2>5 举例使用</h2>
<h3>5.1 创建 DataStore 存储工具子类</h3>
<div class="_2Uzcx_"><button class="VJbwyy" type="button" aria-label="复制代码"><i aria-label="icon: copy" class="anticon anticon-copy"><svg viewBox="64 64 896 896" focusable="false" class="" data-icon="copy" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2L263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></i></button><pre class="line-numbers  language-csharp"><code class="  language-csharp"><span class="token keyword">object</span> IPDataStore <span class="token punctuation">:</span><span class="token function">DataStoreBase</span><span class="token punctuation">(</span><span class="token string">"ip"</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></div>
<h3>5.2 基本使用</h3>
<div class="_2Uzcx_"><button class="VJbwyy" type="button" aria-label="复制代码"><i aria-label="icon: copy" class="anticon anticon-copy"><svg viewBox="64 64 896 896" focusable="false" class="" data-icon="copy" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2L263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></i></button><pre class="line-numbers  language-swift"><code class="  language-swift">  lifecycleScope<span class="token punctuation">.</span>launch <span class="token punctuation">{</span>
            <span class="token builtin">Log</span><span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span><span class="token string">"ip"</span><span class="token punctuation">,</span> <span class="token builtin">IPDataStore</span><span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"ip"</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">:</span><span class="token string">"null"</span><span class="token punctuation">)</span>
            <span class="token builtin">Log</span><span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span><span class="token string">"message_event"</span><span class="token punctuation">,</span> <span class="token builtin">IPDataStore</span><span class="token punctuation">.</span><span class="token function">getMessageEventType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token builtin">Log</span><span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span><span class="token string">"message_event"</span><span class="token punctuation">,</span> <span class="token builtin">IPDataStore</span><span class="token punctuation">.</span><span class="token function">getMessageEventData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            val r <span class="token operator">=</span> <span class="token function">withContext</span><span class="token punctuation">(</span><span class="token builtin">Dispatchers</span><span class="token punctuation">.</span><span class="token constant">IO</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token function">runHttp</span><span class="token punctuation">(</span><span class="token string">"http://ip-api.com/json"</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">:</span> <span class="token builtin">Exception</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token keyword">is</span> <span class="token builtin">String</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token builtin">IPDataStore</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"ip"</span><span class="token punctuation">,</span> r<span class="token punctuation">)</span>
                <span class="token builtin">IPDataStore</span><span class="token punctuation">.</span><span class="token function">putMessageEvent</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">,</span> r<span class="token punctuation">)</span>
                <span class="token builtin">IPDataStore</span><span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"ip"</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">.</span><span class="token keyword">let</span> <span class="token punctuation">{</span>
                    <span class="token builtin">Log</span><span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span><span class="token string">"ip"</span><span class="token punctuation">,</span> it<span class="token operator">?</span><span class="token punctuation">:</span><span class="token string">"null"</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span>

            <span class="token punctuation">}</span>
            <span class="token builtin">Log</span><span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span><span class="token string">"message_event"</span><span class="token punctuation">,</span> <span class="token builtin">IPDataStore</span><span class="token punctuation">.</span><span class="token function">getMessageEventType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token builtin">Log</span><span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span><span class="token string">"message_event"</span><span class="token punctuation">,</span> <span class="token builtin">IPDataStore</span><span class="token punctuation">.</span><span class="token function">getMessageEventData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

            <span class="token builtin">IPDataStore</span><span class="token punctuation">.</span><span class="token function">getMessageEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">.</span><span class="token keyword">let</span> <span class="token punctuation">{</span>
                <span class="token builtin">Log</span><span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span><span class="token string">"message_event"</span><span class="token punctuation">,</span> it<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token builtin">Log</span><span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span><span class="token string">"ip"</span><span class="token punctuation">,</span> <span class="token string">"获取完成"</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>
<div class="_2Uzcx_"><button class="VJbwyy" type="button" aria-label="复制代码"><i aria-label="icon: copy" class="anticon anticon-copy"><svg viewBox="64 64 896 896" focusable="false" class="" data-icon="copy" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2L263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></i></button><pre class="line-numbers  language-kotlin"><code class="  language-kotlin">    <span class="token keyword">var</span> client <span class="token operator">=</span> <span class="token function">OkHttpClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">fun</span> <span class="token function">runHttp</span><span class="token punctuation">(</span>url<span class="token operator">:</span> String<span class="token punctuation">)</span><span class="token operator">:</span> String<span class="token operator">?</span> <span class="token punctuation">{</span>
        <span class="token keyword">val</span> request<span class="token operator">:</span> Request <span class="token operator">=</span> Request<span class="token punctuation">.</span><span class="token function">Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">url</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        client<span class="token punctuation">.</span><span class="token function">newCall</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">use</span> <span class="token punctuation">{</span> response <span class="token operator">-&gt;</span> <span class="token keyword">return</span> response<span class="token punctuation">.</span>body<span class="token operator">!!</span><span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>
<h2>6 混淆</h2>
<div class="_2Uzcx_"><button class="VJbwyy" type="button" aria-label="复制代码"><i aria-label="icon: copy" class="anticon anticon-copy"><svg viewBox="64 64 896 896" focusable="false" class="" data-icon="copy" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2L263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></i></button><pre class="line-numbers  language-dart"><code class="  language-dart"><span class="token operator">-</span>keepclassmembers <span class="token keyword">class</span> <span class="token operator">*</span> <span class="token keyword">extends</span> <span class="token class-name">androidx<span class="token punctuation">.</span>datastore<span class="token punctuation">.</span>preferences<span class="token punctuation">.</span>protobuf<span class="token punctuation">.</span>GeneratedMessageLite</span> <span class="token punctuation">{</span>
    <span class="token operator">&lt;</span>fields<span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></div>
</article>